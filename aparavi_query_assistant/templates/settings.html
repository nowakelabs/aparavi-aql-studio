{% extends "base.html" %}

{% block title %}Settings - Aparavi Query Assistant{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-cog me-2"></i>Application Settings</h4>
            </div>
            <div class="card-body">
                <form id="settings-form" method="post" action="/settings">
                    <!-- API Configuration -->
                    <div class="row mb-4">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-server me-2"></i>Aparavi API Configuration</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="aparavi-server" class="form-label">Aparavi Server</label>
                                <input type="text" class="form-control" id="aparavi-server" name="aparavi_server" 
                                    value="{{ settings.aparavi_server }}" required>
                                <div class="form-text">The hostname or IP address of your Aparavi server</div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" 
                                    value="{{ settings.username }}" required>
                                <div class="form-text">Aparavi API username</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password" 
                                    value="{{ settings.password }}" required>
                                <div class="form-text">Aparavi API password</div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-2 mb-3">
                            <button type="button" id="test-aparavi-connection" class="btn btn-outline-primary">
                                <i class="fas fa-plug me-2"></i>Test Connection
                            </button>
                            <div id="aparavi-connection-result" class="mt-2"></div>
                        </div>
                    </div>
                    
                    <!-- LLM Provider Configuration -->
                    <div class="row mb-4">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-robot me-2"></i>LLM Provider Configuration</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="default-provider" class="form-label">Default LLM Provider</label>
                                <select class="form-select" id="default-provider" name="default_provider">
                                    <option value="auto" {% if settings.default_provider == 'auto' %}selected{% endif %}>Auto (try available providers)</option>
                                    <option value="openai" {% if settings.default_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                                    <option value="claude" {% if settings.default_provider == 'claude' %}selected{% endif %}>Claude</option>
                                    <option value="ollama" {% if settings.default_provider == 'ollama' %}selected{% endif %}>Ollama</option>
                                </select>
                                <div class="form-text">Select your preferred LLM provider</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fallback-provider" class="form-label">Fallback Provider</label>
                                <select class="form-select" id="fallback-provider" name="fallback_provider">
                                    <option value="none" {% if settings.fallback_provider == 'none' %}selected{% endif %}>None (Show error if default fails)</option>
                                    <option value="openai" {% if settings.fallback_provider == 'openai' %}selected{% endif %}>OpenAI</option>
                                    <option value="claude" {% if settings.fallback_provider == 'claude' %}selected{% endif %}>Claude</option>
                                    <option value="ollama" {% if settings.fallback_provider == 'ollama' %}selected{% endif %}>Ollama</option>
                                </select>
                                <div class="form-text">Provider to use if the default provider fails</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- OpenAI Configuration -->
                    <div class="row mb-4" id="openai-config">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-brain me-2"></i>OpenAI Configuration</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai-api-key" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="openai-api-key" name="openai_api_key" 
                                    value="{{ settings.openai_api_key|default('') }}">
                                <div class="form-text">Your OpenAI API key (begins with 'sk-')</div>
                            </div>
                            <div class="mb-3">
                                <button type="button" id="test-openai-connection" class="btn btn-outline-primary">
                                    <i class="fas fa-plug me-2"></i>Test OpenAI Connection
                                </button>
                                <div id="openai-connection-result" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai-model" class="form-label">Model</label>
                                <select class="form-select" id="openai-model" name="openai_model">
                                    <option value="" disabled selected>Loading models...</option>
                                </select>
                                <div class="form-text">Choose which OpenAI model to use</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai-max-tokens" class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" id="openai-max-tokens" name="openai_max_tokens" 
                                    value="{{ settings.openai_max_tokens|default(4096) }}" min="500" max="8192">
                                <div class="form-text">Maximum tokens for completion</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="openai-temperature" class="form-label">Temperature</label>
                                <input type="range" class="form-range" id="openai-temperature" name="openai_temperature" 
                                    value="{{ settings.openai_temperature|default(0.1) }}" min="0" max="1" step="0.1">
                                <div class="d-flex justify-content-between">
                                    <span>0.0 (Deterministic)</span>
                                    <span>1.0 (Creative)</span>
                                </div>
                                <div class="form-text">Controls randomness of responses</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Claude Configuration -->
                    <div class="row mb-4" id="claude-config">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-brain me-2"></i>Claude Configuration</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="claude-api-key" class="form-label">API Key</label>
                                <input type="password" class="form-control" id="claude-api-key" name="claude_api_key" 
                                    value="{% if settings.claude_api_key and not 'Error' in settings.claude_api_key %}{{ settings.claude_api_key }}{% endif %}">
                                <div class="form-text">Your Anthropic API key</div>
                            </div>
                            <div class="mb-3">
                                <button type="button" id="test-claude-connection" class="btn btn-outline-primary">
                                    <i class="fas fa-plug me-2"></i>Test Claude Connection
                                </button>
                                <div id="claude-connection-result" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="claude-model" class="form-label">Model</label>
                                <select class="form-select" id="claude-model" name="claude_model">
                                    <option value="claude-3-opus-20240229" {% if settings.claude_model == 'claude-3-opus-20240229' or not settings.claude_model %}selected{% endif %}>Claude 3 Opus</option>
                                    <option value="claude-3-sonnet-20240229" {% if settings.claude_model == 'claude-3-sonnet-20240229' %}selected{% endif %}>Claude 3 Sonnet</option>
                                    <option value="claude-3-haiku-20240307" {% if settings.claude_model == 'claude-3-haiku-20240307' %}selected{% endif %}>Claude 3 Haiku</option>
                                    <option value="claude-2.1" {% if settings.claude_model == 'claude-2.1' %}selected{% endif %}>Claude 2.1</option>
                                    <option value="claude-2.0" {% if settings.claude_model == 'claude-2.0' %}selected{% endif %}>Claude 2.0</option>
                                </select>
                                <div class="form-text">Choose which Claude model to use</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="claude-max-tokens" class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" id="claude-max-tokens" name="claude_max_tokens" 
                                    value="{{ settings.claude_max_tokens|default(4096) }}" min="500" max="8192">
                                <div class="form-text">Maximum tokens for completion</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="claude-temperature" class="form-label">Temperature</label>
                                <input type="range" class="form-range" id="claude-temperature" name="claude_temperature" 
                                    value="{{ settings.claude_temperature|default(0.1) }}" min="0" max="1" step="0.1">
                                <div class="d-flex justify-content-between">
                                    <span>0.0 (Deterministic)</span>
                                    <span>1.0 (Creative)</span>
                                </div>
                                <div class="form-text">Controls randomness of responses</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ollama Configuration -->
                    <div class="row mb-4" id="ollama-config">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-microchip me-2"></i>Ollama Configuration</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ollama-base-url" class="form-label">Base URL</label>
                                <input type="text" class="form-control" id="ollama-base-url" name="ollama_base_url" 
                                    value="{{ settings.ollama_base_url|default('http://localhost:11434') }}">
                                <div class="form-text">URL where Ollama server is running (default: http://localhost:11434)</div>
                            </div>
                            <div class="mb-3">
                                <button type="button" id="test-ollama-connection" class="btn btn-outline-primary">
                                    <i class="fas fa-plug me-2"></i>Test Ollama Connection
                                </button>
                                <div id="ollama-connection-result" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ollama-model" class="form-label">Model</label>
                                <select class="form-select" id="ollama-model" name="ollama_model">
                                    <option value="" disabled selected>Loading models...</option>
                                </select>
                                <div class="form-text">Select a model from your Ollama instance (refreshed on page load)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Settings -->
                    <div class="row mb-4">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-sliders-h me-2"></i>System Settings</h5>
                            <hr>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="log-level" class="form-label">Log Level</label>
                                <select class="form-select" id="log-level" name="log_level">
                                    <option value="DEBUG" {% if settings.log_level == 'DEBUG' %}selected{% endif %}>Debug</option>
                                    <option value="INFO" {% if settings.log_level == 'INFO' %}selected{% endif %}>Info</option>
                                    <option value="WARNING" {% if settings.log_level == 'WARNING' %}selected{% endif %}>Warning</option>
                                    <option value="ERROR" {% if settings.log_level == 'ERROR' %}selected{% endif %}>Error</option>
                                </select>
                                <div class="form-text">Logging verbosity level</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cache-timeout" class="form-label">Cache Timeout (seconds)</label>
                                <input type="number" class="form-control" id="cache-timeout" name="cache_timeout" 
                                    value="{{ settings.cache_timeout }}" min="0" max="86400">
                                <div class="form-text">How long to cache query results (0 to disable caching)</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AQL Library Management -->
                    <div class="row mb-4">
                        <div class="col-md-12 mb-3">
                            <h5><i class="fas fa-database me-2"></i>AQL Library Management</h5>
                            <hr>
                        </div>
                        <div class="col-md-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Import/Export Library</h6>
                                    <p class="card-text small mb-3">Back up or restore your AQL query library. When importing, a backup of the current library will be automatically created.</p>
                                    
                                    <div class="d-flex flex-wrap gap-3">
                                        <!-- Export Library Button -->
                                        <a href="/library/export" class="btn btn-primary" download="aql_library.json">
                                            <i class="fas fa-file-export me-2"></i>Export Library
                                        </a>
                                        
                                        <!-- Import Library Form -->
                                        <div>
                                            <form id="import-library-form" action="/library/import" method="post" enctype="multipart/form-data" class="d-inline-flex gap-2 align-items-center">
                                                <div class="input-group">
                                                    <input type="file" class="form-control" id="library-file" name="library_file" accept=".json" required>
                                                    <button type="submit" class="btn btn-success" id="import-library-btn">
                                                        <i class="fas fa-file-import me-2"></i>Import Library
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3" id="import-status"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="reset" class="btn btn-outline-secondary">Reset</button>
                        <button type="submit" class="btn btn-primary" id="save-settings-btn">Save Settings</button>
                    </div>
                    
                    <!-- Debug data for form validation -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        {% for category, message in messages %}
                          <div class="alert alert-{{ category }} mt-3">
                            {{ message }}
                          </div>
                        {% endfor %}
                      {% endif %}
                    {% endwith %}
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form validation function
    function validateForm() {
        const server = document.getElementById('aparavi-server').value;
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Check required fields
        if (!server || !username || !password) {
            // Show validation error
            alert('Please fill in all required fields: Aparavi Server, Username, and Password');
            return false;
        }
        
        console.log('Form validation passed');
        return true;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Settings page loaded');
        const defaultProvider = document.getElementById('default-provider');
        const fallbackProvider = document.getElementById('fallback-provider');
        const ollamaConfig = document.getElementById('ollama-config');
        const openaiConfig = document.getElementById('openai-config'); 
        const claudeConfig = document.getElementById('claude-config');
        const ollamaModelSelect = document.getElementById('ollama-model');
        const openaiModelSelect = document.getElementById('openai-model');
        const claudeModelSelect = document.getElementById('claude-model');
        const ollamaBaseUrl = document.getElementById('ollama-base-url');
        const openaiApiKey = document.getElementById('openai-api-key');
        const claudeApiKey = document.getElementById('claude-api-key');
        const settingsForm = document.getElementById('settings-form');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        
        // Ensure form submission works
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Validate the form
                if (validateForm()) {
                    console.log('Form is valid, submitting...');
                    settingsForm.submit();
                } else {
                    console.log('Form validation failed');
                }
            });
        }
        
        // Function to fetch available Ollama models
        function fetchOllamaModels() {
            fetch('/api/ollama/models')
                .then(response => response.json())
                .then(data => {
                    // Clear loading option
                    ollamaModelSelect.innerHTML = '';
                    
                    if (data.status === 'success' && data.models && data.models.length > 0) {
                        // First, add a default option (tinyllama) if it's in the list
                        const tinyllamaIndex = data.models.findIndex(model => model === 'tinyllama');
                        
                        if (tinyllamaIndex !== -1) {
                            // Move tinyllama to the beginning and mark as default
                            const option = document.createElement('option');
                            option.value = 'tinyllama';
                            option.textContent = 'tinyllama (Default)';
                            
                            // Select if it matches current setting or if there's no setting
                            if ('{{ settings.ollama_model }}' === '' || '{{ settings.ollama_model }}' === 'tinyllama') {
                                option.selected = true;
                            }
                            
                            ollamaModelSelect.appendChild(option);
                            
                            // Remove tinyllama from the array so we don't add it twice
                            data.models.splice(tinyllamaIndex, 1);
                        }
                        
                        // Add the rest of the models from the API response
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            
                            // Select this model if it matches the current setting
                            if (model === '{{ settings.ollama_model }}') {
                                option.selected = true;
                            }
                            
                            ollamaModelSelect.appendChild(option);
                        });
                    } else {
                        // If no models or error, show message
                        const option = document.createElement('option');
                        option.value = 'tinyllama';
                        option.textContent = 'tinyllama (Default)';
                        option.selected = true;
                        ollamaModelSelect.appendChild(option);
                        
                        // Add a few other common models as options
                        ['mistral', 'gemma:7b', 'phi3'].forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            ollamaModelSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching Ollama models:', error);
                    
                    // Add default options in case of error
                    ollamaModelSelect.innerHTML = '';
                    const models = ['tinyllama', 'mistral', 'gemma:7b', 'phi3'];
                    
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        
                        // Select tinyllama as default or match current setting
                        if ((model === 'tinyllama' && '{{ settings.ollama_model }}' === '') || 
                            model === '{{ settings.ollama_model }}') {
                            option.selected = true;
                        }
                        
                        ollamaModelSelect.appendChild(option);
                    });
                });
        }
        
        // Refetch models when base URL changes
        ollamaBaseUrl.addEventListener('change', fetchOllamaModels);
        
        // Function to fetch available OpenAI models
        function fetchOpenAIModels() {
            fetch('/api/openai/models')
                .then(response => response.json())
                .then(data => {
                    // Clear existing options
                    openaiModelSelect.innerHTML = '';
                    
                    if (data.status === 'success' && data.models && data.models.length > 0) {
                        // Add models to dropdown
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            
                            // Select the current model if it matches
                            if (model === '{{ settings.openai_model }}') {
                                option.selected = true;
                            }
                            
                            openaiModelSelect.appendChild(option);
                        });
                    } else {
                        // Default models if API call fails
                        const defaultModels = [
                            'gpt-3.5-turbo',
                            'gpt-4',
                            'gpt-4-turbo'
                        ];
                        
                        defaultModels.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            
                            if (model === '{{ settings.openai_model }}') {
                                option.selected = true;
                            } else if (model === 'gpt-3.5-turbo' && '{{ settings.openai_model }}' === '') {
                                option.selected = true;
                            }
                            
                            openaiModelSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching OpenAI models:', error);
                    
                    // Add default options in case of error
                    openaiModelSelect.innerHTML = '';
                    const defaultModels = [
                        'gpt-3.5-turbo',
                        'gpt-4',
                        'gpt-4-turbo'
                    ];
                    
                    defaultModels.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        
                        if (model === '{{ settings.openai_model }}') {
                            option.selected = true;
                        } else if (model === 'gpt-3.5-turbo' && '{{ settings.openai_model }}' === '') {
                            option.selected = true;
                        }
                        
                        openaiModelSelect.appendChild(option);
                    });
                });
        }
        
        function updateProviderConfigs() {
            // Show/hide Ollama config
            if (defaultProvider.value === 'ollama' || fallbackProvider.value === 'ollama') {
                ollamaConfig.style.display = 'flex';
            } else {
                ollamaConfig.style.display = 'none';
            }
            
            // Show/hide OpenAI config
            if (defaultProvider.value === 'openai' || fallbackProvider.value === 'openai') {
                openaiConfig.style.display = 'flex';
            } else {
                openaiConfig.style.display = 'none';
            }
            
            // Show/hide Claude config
            if (defaultProvider.value === 'claude' || fallbackProvider.value === 'claude') {
                claudeConfig.style.display = 'flex';
            } else {
                claudeConfig.style.display = 'none';
            }
        }
        
        // Register change event handlers
        defaultProvider.addEventListener('change', updateProviderConfigs);
        fallbackProvider.addEventListener('change', updateProviderConfigs);
        
        // Initialize the form
        updateProviderConfigs();
        
        // Fetch models on page load
        fetchOllamaModels();
        fetchOpenAIModels();
        
        // Handle Library Import Form
        const importForm = document.getElementById('import-library-form');
        const importStatus = document.getElementById('import-status');
        const importButton = document.getElementById('import-library-btn');
        
        if (importForm) {
            importForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading state
                importButton.disabled = true;
                const originalBtnText = importButton.innerHTML;
                importButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importing...';
                importStatus.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Processing import...</div>';
                
                // Create FormData object
                const formData = new FormData(importForm);
                
                // Submit via AJAX
                fetch('/library/import', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        importStatus.innerHTML = `<div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>${data.message}
                            <div class="mt-2 small">
                                <strong>Summary:</strong> Imported ${data.imported_count} queries. 
                                A backup of the previous library was created as ${data.backup_file}
                            </div>
                        </div>`;
                        
                        // Reset form
                        importForm.reset();
                    } else {
                        importStatus.innerHTML = `<div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>${data.error}
                        </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error importing library:', error);
                    importStatus.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>Error: ${error.message || 'Failed to import library'}
                    </div>`;
                })
                .finally(() => {
                    // Reset button state
                    importButton.disabled = false;
                    importButton.innerHTML = originalBtnText;
                });
            });
        }
        
        // Test Aparavi Connection
        const testAparaviButton = document.getElementById('test-aparavi-connection');
        const aparaviConnectionResult = document.getElementById('aparavi-connection-result');
        
        testAparaviButton.addEventListener('click', async function() {
            // Update UI to show testing state
            testAparaviButton.disabled = true;
            testAparaviButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            aparaviConnectionResult.innerHTML = '';
            
            try {
                // Get current form values
                const server = document.getElementById('aparavi-server').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                // Validate inputs
                if (!server || !username || !password) {
                    aparaviConnectionResult.innerHTML = '<div class="alert alert-warning">Please fill in all Aparavi connection fields.</div>';
                    return;
                }
                
                // Call the API to test connection
                const response = await fetch('/api/test_aparavi_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        server,
                        username,
                        password,
                        // Include default API endpoint
                        endpoint: '/server/api/v3/database/query'
                    })
                });
                
                const data = await response.json();
                
                // Display results
                if (data.success) {
                    aparaviConnectionResult.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                    </div>`;
                } else {
                    aparaviConnectionResult.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                    </div>`;
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                aparaviConnectionResult.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error testing connection: ${error.message}
                </div>`;
            } finally {
                // Reset button state
                testAparaviButton.disabled = false;
                testAparaviButton.innerHTML = '<i class="fas fa-plug me-2"></i>Test Connection';
            }
        });
        
        // Test OpenAI Connection
        const testOpenAIButton = document.getElementById('test-openai-connection');
        const openaiConnectionResult = document.getElementById('openai-connection-result');
        
        testOpenAIButton.addEventListener('click', async function() {
            // Update UI to show testing state
            testOpenAIButton.disabled = true;
            testOpenAIButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            openaiConnectionResult.innerHTML = '';
            
            try {
                // Get current form values
                const apiKey = document.getElementById('openai-api-key').value;
                
                // Validate inputs
                if (!apiKey) {
                    openaiConnectionResult.innerHTML = '<div class="alert alert-warning">Please fill in the OpenAI API key.</div>';
                    return;
                }
                
                // Call the API to test connection
                const response = await fetch('/api/test_openai_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                
                // Display results
                if (data.success) {
                    openaiConnectionResult.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                    </div>`;
                } else {
                    openaiConnectionResult.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                    </div>`;
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                openaiConnectionResult.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error testing connection: ${error.message}
                </div>`;
            } finally {
                // Reset button state
                testOpenAIButton.disabled = false;
                testOpenAIButton.innerHTML = '<i class="fas fa-plug me-2"></i>Test OpenAI Connection';
            }
        });
        
        // Test Claude Connection
        const testClaudeButton = document.getElementById('test-claude-connection');
        const claudeConnectionResult = document.getElementById('claude-connection-result');
        
        testClaudeButton.addEventListener('click', async function() {
            // Update UI to show testing state
            testClaudeButton.disabled = true;
            testClaudeButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            claudeConnectionResult.innerHTML = '';
            
            try {
                // Get current form values
                const apiKey = document.getElementById('claude-api-key').value;
                
                // Validate inputs
                if (!apiKey) {
                    claudeConnectionResult.innerHTML = '<div class="alert alert-warning">Please fill in the Claude API key.</div>';
                    return;
                }
                
                // Call the API to test connection
                const response = await fetch('/api/test_claude_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                
                // Display results
                if (data.success) {
                    claudeConnectionResult.innerHTML = `<div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                    </div>`;
                } else {
                    claudeConnectionResult.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                    </div>`;
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                claudeConnectionResult.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error testing connection: ${error.message}
                </div>`;
            } finally {
                // Reset button state
                testClaudeButton.disabled = false;
                testClaudeButton.innerHTML = '<i class="fas fa-plug me-2"></i>Test Claude Connection';
            }
        });
        
        // Test Ollama Connection
        const testOllamaButton = document.getElementById('test-ollama-connection');
        const ollamaConnectionResult = document.getElementById('ollama-connection-result');
        
        testOllamaButton.addEventListener('click', async function() {
            // Update UI to show testing state
            testOllamaButton.disabled = true;
            testOllamaButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
            ollamaConnectionResult.innerHTML = '';
            
            try {
                // Get current form values
                const baseUrl = document.getElementById('ollama-base-url').value;
                
                // Validate inputs
                if (!baseUrl) {
                    ollamaConnectionResult.innerHTML = '<div class="alert alert-warning">Please fill in the Ollama base URL.</div>';
                    testOllamaButton.disabled = false;
                    testOllamaButton.innerHTML = '<i class="fas fa-plug me-2"></i>Test Ollama Connection';
                    return;
                }
                
                // Call the API to test connection
                const response = await fetch('/api/test_ollama_connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        base_url: baseUrl
                    })
                });
                
                const data = await response.json();
                
                // Display results
                if (data.success) {
                    if (data.has_models) {
                        // Normal success case - models exist
                        ollamaConnectionResult.innerHTML = `<div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>${data.message}
                        </div>`;
                        
                        // Refresh the list of available models
                        fetchOllamaModels();
                    } else {
                        // Connection works but no models found - offer to download one
                        ollamaConnectionResult.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                                <div class="mt-3">
                                    <p>Choose a model to download:</p>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="button" class="btn btn-sm btn-outline-primary download-ollama-model" data-model="tinyllama">
                                            Download tinyllama (small, ~1.1GB)
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary download-ollama-model" data-model="mistral">
                                            Download mistral (medium, ~4GB)
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary download-ollama-model" data-model="gemma:7b">
                                            Download gemma:7b (large, ~5GB)
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                            
                        // Add event listeners to download buttons
                        document.querySelectorAll('.download-ollama-model').forEach(btn => {
                            btn.addEventListener('click', async function() {
                                const modelName = this.getAttribute('data-model');
                                const downloadBtn = this;
                                
                                // Update UI
                                downloadBtn.disabled = true;
                                downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Downloading...`;
                                
                                try {
                                    // Call API to start the download
                                    const downloadResponse = await fetch('/api/ollama/pull_model', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            base_url: baseUrl,
                                            model: modelName
                                        })
                                    });
                                    
                                    const downloadData = await downloadResponse.json();
                                    
                                    if (downloadData.success) {
                                        // Show success and disable all buttons
                                        document.querySelectorAll('.download-ollama-model').forEach(b => {
                                            b.disabled = true;
                                        });
                                        
                                        // Update this button to show success
                                        downloadBtn.classList.remove('btn-outline-primary');
                                        downloadBtn.classList.add('btn-success');
                                        downloadBtn.innerHTML = `<i class="fas fa-check me-2"></i>Downloading...`;
                                        
                                        // Show additional information
                                        const infoEl = document.createElement('div');
                                        infoEl.className = 'alert alert-info mt-3';
                                        infoEl.innerHTML = `
                                            <p><strong>Download in progress!</strong> ${downloadData.message}</p>
                                            <p class="mb-0">After the download completes, click the Test Connection button again to verify.</p>
                                        `;
                                        ollamaConnectionResult.appendChild(infoEl);
                                        
                                        // Set up polling to check download status
                                        const downloadModel = modelName;
                                        let checkCount = 0;
                                        const maxChecks = 120; // 10 minutes max (5s * 120)
                                        const statusCheckInterval = setInterval(async function() {
                                            try {
                                                // Check if the model exists now
                                                const checkResponse = await fetch('/api/ollama/check_model', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json'
                                                    },
                                                    body: JSON.stringify({
                                                        base_url: baseUrl,
                                                        model: downloadModel
                                                    })
                                                });
                                                
                                                const checkData = await checkResponse.json();
                                                checkCount++;
                                                
                                                // If the model exists now, the download is complete
                                                if (checkData.success && checkData.exists) {
                                                    // Clear the interval - we're done checking
                                                    clearInterval(statusCheckInterval);
                                                    
                                                    // Update UI to show completion
                                                    downloadBtn.innerHTML = `<i class="fas fa-check me-2"></i>Download Complete!`;
                                                    infoEl.innerHTML = `
                                                        <p><strong>Success!</strong> Model '${downloadModel}' is now available.</p>
                                                        <div class="mt-2">
                                                            <button type="button" id="refresh-after-download" class="btn btn-primary">
                                                                <i class="fas fa-sync me-2"></i>Refresh Model List
                                                            </button>
                                                        </div>
                                                    `;
                                                    
                                                    // Add click handler for the refresh button
                                                    document.getElementById('refresh-after-download').addEventListener('click', function() {
                                                        // Update ollama model dropdown in the form
                                                        fetchOllamaModels();
                                                        
                                                        // Update the connection status
                                                        testOllamaButton.click();
                                                    });
                                                    
                                                    // Auto refresh the model list
                                                    setTimeout(() => {
                                                        fetchOllamaModels();
                                                    }, 1000);
                                                }
                                                // If download still in progress, update progress
                                                else if (checkData.success && checkData.downloading) {
                                                    downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i>Downloading (${checkData.progress}%)`;
                                                }
                                                // If we've checked too many times, stop
                                                else if (checkCount >= maxChecks) {
                                                    clearInterval(statusCheckInterval);
                                                    infoEl.innerHTML += `
                                                        <div class="alert alert-warning mt-2">
                                                            <p>Download status check timed out. The download may still be in progress.</p>
                                                            <p>Please check your Ollama server and click the Test Connection button again when ready.</p>
                                                        </div>
                                                    `;
                                                }
                                            } catch (checkError) {
                                                console.error('Error checking model status:', checkError);
                                                // Don't stop checking on error - just log and continue
                                            }
                                        }, 5000); // Check every 5 seconds
                                    } else {
                                        // Show error
                                        downloadBtn.disabled = false;
                                        downloadBtn.innerHTML = `Download ${modelName}`;
                                        
                                        const errorEl = document.createElement('div');
                                        errorEl.className = 'alert alert-danger mt-3';
                                        errorEl.innerHTML = `<p><strong>Error:</strong> ${downloadData.message}</p>`;
                                        ollamaConnectionResult.appendChild(errorEl);
                                    }
                                } catch (downloadError) {
                                    console.error('Error starting model download:', downloadError);
                                    downloadBtn.disabled = false;
                                    downloadBtn.innerHTML = `Download ${modelName}`;
                                    
                                    const errorEl = document.createElement('div');
                                    errorEl.className = 'alert alert-danger mt-3';
                                    errorEl.innerHTML = `<p><strong>Error:</strong> ${downloadError.message}</p>`;
                                    ollamaConnectionResult.appendChild(errorEl);
                                }
                            });
                        });
                    }
                } else {
                    ollamaConnectionResult.innerHTML = `<div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>${data.message}
                    </div>`;
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                ollamaConnectionResult.innerHTML = `<div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>Error testing connection: ${error.message}
                </div>`;
            } finally {
                // Reset button state
                testOllamaButton.disabled = false;
                testOllamaButton.innerHTML = '<i class="fas fa-plug me-2"></i>Test Ollama Connection';
            }
        });
    });
</script>
{% endblock %}
